<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Implementamos una loot table y
hacemos una aproximación a traves de código de como se podría construir
el sistema que utiliza diablo 3 a la hora de lootear equipamiento y
objetos." />
    <title>S3r0s4pi3ns - Diablo 3 loot system con python</title>
    <link rel="stylesheet" href="../../styles/normalize.css" />
    <link rel="stylesheet" href="../../styles/globals.css" />
    <link rel="stylesheet" href="../../styles/article.css" />
  </head>
  <body>
    <main>
      <div class="terminal">
        <pre>
          <span class="output" data-prompt="blog/2023/diablo3-loot-system-con-python"><a class="terminal-link" href="/">cd &#36;HOME</a></span>
        </pre>
      </div>
      <article>
        <header>
          <h1>Diablo 3 loot system con python</h1>
                    <img src="/assets/images/stable_difussion_diablo3_logo.jpg" alt="article_thumbnail" />
                  </header>
      </article>
      <section><ul>
<li><a href="#aprendiendo-un-nuevo-lenguaje">Aprendiendo un nuevo
lenguaje</a></li>
<li><a href="#el-aprendizaje-no-lineal">El aprendizaje no-lineal</a>
<ul>
<li><a
href="#enumerando-las-reglas-para-alcanzar-nuestro-objetivo">Enumerando
las reglas para alcanzar nuestro objetivo</a>
<ul>
<li><a href="#equipamiento">Equipamiento</a></li>
<li><a href="#rareza-del-objeto">Rareza del objeto</a></li>
<li><a href="#exclusividad-de-equipo">Exclusividad de equipo</a></li>
<li><a href="#nivel-y-dificultad">Nivel y dificultad</a></li>
<li><a href="#rango-de-estadisticas">Rango de estadisticas</a></li>
<li><a href="#origen-del-loot">Origen del loot</a></li>
</ul></li>
</ul></li>
<li><a href="#trazando-un-estado-inicial-para-el-proyecto">Trazando un
estado inicial para el proyecto</a>
<ul>
<li><a href="#clase-character-en-characterpy">Clase Character en
character.py</a></li>
<li><a href="#loot-table-maestra-solo-con-origen-cofre">Loot table
maestra solo con origen cofre</a></li>
</ul></li>
<li><a href="#sentando-las-bases-en-lootpy">Sentando las bases en
loot.py</a>
<ul>
<li><a href="#cargando-items-en-el-pool-seleccionado">Cargando items en
el pool seleccionado</a></li>
<li><a href="#seleccionando-items-en-base-a-su-peso">Seleccionando items
en base a su peso</a>
<ul>
<li><a
href="#creando-la-función-que-aplica-el-calculo-de-weight">Creando la
función que aplica el calculo de weight</a></li>
</ul></li>
<li><a href="#cálculo-del-drop-para-cada-item">Cálculo del drop para
cada item</a></li>
</ul></li>
<li><a href="#scrapper-para-generar-nuestros-archivos-json">Scrapper
para generar nuestros archivos .json</a>
<ul>
<li><a href="#generar-archivos-json-de-equipamiento">Generar archivos
.json de equipamiento</a></li>
<li><a href="#precarga-de-los-archivos-en-lootpy">Precarga de los
archivos en loot.py</a></li>
</ul></li>
<li><a href="#no-nos-olvidemos-del-oro">No nos olvidemos del
oro</a></li>
<li><a href="#gemas-everywhere">Gemas everywhere</a>
<ul>
<li><a href="#aplicando-el-drop-chance-para-las-gemas">Aplicando el drop
chance para las gemas</a></li>
</ul></li>
<li><a
href="#tuneando-el-script-para-recibir-argumentos-y-lanzar-n-simulaciones">Tuneando
el script para recibir argumentos y lanzar n simulaciones</a>
<ul>
<li><a href="#argparse-al-rescate">Argparse al rescate</a></li>
<li><a href="#mostrando-resultados-en-pantalla-a-modo-resumen">Mostrando
resultados en pantalla a modo resumen</a></li>
</ul></li>
<li><a href="#palabras-finales">Palabras finales</a></li>
<li><a href="#fuentes">Fuentes</a></li>
</ul>
<h1 id="aprendiendo-un-nuevo-lenguaje">Aprendiendo un nuevo
lenguaje</h1>
<p>La metodología que uso para aprender un nuevo lenguaje es hacer cosas
con el, suena simple pero no lo es del todo. Este metodo no va a
funcionar con aquellas personas que esten empezando en el mundo de la
programación sino para aquell@s que ya saben programar y quieren pivotar
a otro lenguaje, probar otros paradigmas, etc.</p>
<p>Podría embaucarme en el eterno viaje de tutoriales en video,
articulos de blog, documentación y un largo coñazo mas pero prefiero
tener una idea en mente y proyectarla con el nuevo lenguaje e ir
aprendiendo la sintaxis y conceptos sobre la marcha, tan rudimentario
como efectivo.</p>
<p>Después de llevar largas horas farmeando en diablo para hacerme las
builds de la temporada 28 para todos los personajes, me apetecía simular
un sistema de loot parecido al de diablo a niveles bastante
reduccionistas claro está, el de diablo 3 tiene que conllevar mucha mas
complejidad pero para empezar me vale.</p>
<p>Algo muy distinto al tipico TODO list que ya aburre infinito.</p>
<p><strong><em>Puedes acceder al repositorio completo aquí: <a
href="https://github.com/s3r0s4pi3ns/python-diablo3-loot-system">https://github.com/s3r0s4pi3ns/python-diablo3-loot-system</a></em></strong></p>
<h1 id="el-aprendizaje-no-lineal">El aprendizaje no-lineal</h1>
<p>A mi personalmente no me funciona el aprendizaje lineal en el que te
lees los capitulos por orden númerico ascendente, prefiero hacer una
pequeña mezcla de teoria-práctica en espacios cortos de tiempo mientras
voy hilvanando los conceptos para conseguir un mapa mental adecuado, por
ejemplo, leo el concepto de diccionario en python y al momento me pongo
a teclear para crear memoria muscular e interiorizar esa teoría creando
e interaccionando con un diccionario.</p>
<p>Hago un enfoque similar para este proyecto de crear el sistema de
loot en python, voy desglosando las funcionalidades que quiero ir
aplicando antes de escribir código, un poco de música y a enfrentarme
con lo desconocido.</p>
<h2 id="enumerando-las-reglas-para-alcanzar-nuestro-objetivo">Enumerando
las reglas para alcanzar nuestro objetivo</h2>
<p>Sin grandes complicaciones, quiero tener la posibilidad de ejecutar
<strong>n simulaciones</strong> y me devuelva la información de las
cantidades looteadas para ver si los porcentajes de drop se asocian a un
buen gameplay donde se premia la constancia. Vamos a ponernos en
contexto con las características principales que dispone el sistema de
loot enumerando los items y los condicionantes que lo rodean:</p>
<h3 id="equipamiento">Equipamiento</h3>
<p>Tener claro el equipamiento que puede disponer nuestro personaje nos
acercará a una mayor precision y realismo a la hora de crear nuestras
loot tables:</p>
<ul>
<li>Yelmo</li>
<li>Peto</li>
<li>Hombros</li>
<li>Brazos</li>
<li>Cinto</li>
<li>Piernas</li>
<li>pies</li>
<li>2 Huecos para anillos</li>
<li>1 Hueco para amuleto</li>
<li>Arma 2 manos</li>
<li>Arma 1 mano</li>
<li>Soporte 1 mano <em>(Off-hand)</em>, Escudo, orbe, mascara de vodoo…
<em>(si utilizas arma 1 mano puedes utilizar la otra para un item de
este tipo)</em></li>
</ul>
<p>Esto influye a la hora de seleccionar un rango amplio de objetos a la
hora de lootear por lo que da una experiencia mas variada</p>
<h3 id="rareza-del-objeto">Rareza del objeto</h3>
<p>La rareza del objeto se divide en: Normal, Magico, Raro, Legendario,
Legendario ancestral, Legendario ancestral primigenio, Conjunto
<em>(ancestral, primigenio)</em></p>
<ul>
<li>Las piezas de conjunto tienen efectos adicionales si se equipan
varias de las piezas.</li>
<li>El equipamiento tiene su propio nivel que va acorde con el
personaje, esto quiere decir que las estadísticas generadas del objeto
tendran esta limitación y habra que formar un calculo para ello.</li>
<li>Piezas de conjunto, ancestrales, primigenios solo lootean a partir
del nivel 70 de personaje, el equipamiento que se lootea siempre debe
ser menor o igual que el actual nivel del personaje <em>(si eres nivel
40, solo te aparecen raros o legendarios de &lt;= 40)</em></li>
<li>Los objetos de tipo ancestral o primigenio solo se podran acceder si
se jugan fallas de nivel superior +70 en dificultades superiores a
tormento I</li>
<li>Si en el loot aparece un legendario/conjunto, hay una posibilidad 1
entre x <em>(habra que definir x)</em> de que este sea ancestral o
primigenio los cuales pueden ofrecer estadisticas mas altas.</li>
</ul>
<h3 id="exclusividad-de-equipo">Exclusividad de equipo</h3>
<p>Hay equipo global que puede usar cualquier personaje pero su
generación será diferente, si el atributo principal es inteligencia,
estos objetos vendran con propiedades mágicas acorde a este atributo o
habilidades que solo la clase puede utilizar.</p>
<p>Las piezas de conjunto se desbloquean en base a la clase del
personaje que estamos utilizando, si usamos un mago solo lootearemos
sets equipamiento para esta clase en particular. <strong><em>Se que hay
veces que una pieza de conjunto de otra clase se lootea pero por
simplificar la lógica no voy a implementar esta característica en el
sistema de loot</em></strong></p>
<h3 id="nivel-y-dificultad">Nivel y dificultad</h3>
<p>El nivel y la dificultad en la que se está jugando influye en los
porcentajes de loot para los objetos legendarios y de conjunto.</p>
<h3 id="rango-de-estadisticas">Rango de estadisticas</h3>
<p>El equipamiento se lootea con unas estadísticas aleatorios siempre en
base a unas reglas básicas que ese objeto puede admitir y pueden ser por
ejemplo, entre 700 y 1000 de daño, 4 propiedades magicas aleatorias,
inteligencia del personaje * 0.4 + (400 ~700) y un largo etc.</p>
<h3 id="origen-del-loot">Origen del loot</h3>
<p>Este apartado se refiere a si se ha abierto un cofre, matado un
enemigo, completado un evento. Segun el origen, el proceso de loot
recibirá ciertas reglas y calculos especiales para ese loot en
especifico. Usaremos claves en el formato <code>origen:tipo</code> que
seran una via de acceso a nuestro pool y su forma de generarse.</p>
<p><strong>Ejemplos:</strong> <em><em>chest.normal,
greater_rift.killed_guardian, chest.diabolic</em></em></p>
<h1 id="trazando-un-estado-inicial-para-el-proyecto">Trazando un estado
inicial para el proyecto</h1>
<p>Como cualquier inicio necesitamos un punto de partida para ir
pivotando y desarrollando sobre el para ver hasta donde podemos llegar.
Teniendo las reglas basicas anteriores en mente vamos a crear nuestras
primeras carpetas y archivos:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> character.py</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> data</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   ├── equipment</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   ├── character_set_equipment.json</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   ├── legendary_equipment.json</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   ├── magic_equipment.json</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   ├── normal_equipment.json</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   └── rare_equipment.json</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   ├── gems</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   │   └── gems.json</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   └── loot_table.json</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> loot.py</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> requirements.txt</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> scrapper</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">└──</span> equipment.py</span></code></pre></div>
<ul>
<li><code>character.py</code> será un modulo con la
<code>clase Character</code> que representara un personaje de Diablo III
y contendrá datos básicos como el nivel y clase.</li>
<li><code>data</code> esta dividido en <code>equipment</code> donde
volcaremos los items que usaremos en el loot segun el tipo de rareza y
<code>gems</code> donde tendremos los tipos de gemas disponibles en el
loot</li>
<li><code>loot_table.json</code> es nuestra tabla maestra y definirá el
template de cada tipo de origen como pueden ser cofre, enemigo,
mapa…</li>
<li><code>scrapper</code> Con esta funcionalidad extraeremos los items
oficiales del juego desde la <a
href="https://us.diablo3.blizzard.com/en-us">página oficial de
blizzard</a>, he decidido este camino porque su API oficial es bastante
mala a la hora de consumirla.</li>
</ul>
<h2 id="clase-character-en-character.py">Clase Character en
character.py</h2>
<p>Para modularizar el código vamos a empezar separando esta clase ya
que <code>loot.py</code> va a crecer como el pene de un adolescente
salido estudiando matemáticas a las 17:00 de la tarde:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> random <span class="im">import</span> randint, choice</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Annotated</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># CHARACTER CLASSES</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>BARBARIAN <span class="op">=</span> <span class="st">&#39;barbarian&#39;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>WIZARD <span class="op">=</span> <span class="st">&#39;wizard&#39;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>NECROMANCER <span class="op">=</span> <span class="st">&#39;necromancer&#39;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>WITCH_DOCTOR <span class="op">=</span> <span class="st">&#39;witch doctor&#39;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>DEMON_HUNTER <span class="op">=</span> <span class="st">&#39;demon hunter&#39;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>CRUSADER <span class="op">=</span> <span class="st">&#39;crusader&#39;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>MONK <span class="op">=</span> <span class="st">&#39;monk&#39;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>GAME_CLASSES <span class="op">=</span> [</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    BARBARIAN, WIZARD, NECROMANCER, WITCH_DOCTOR, DEMON_HUNTER, CRUSADER,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    MONK</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Character:</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, level: <span class="bu">int</span> <span class="op">=</span> <span class="va">None</span>, character_class: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.level: <span class="bu">int</span> <span class="op">=</span> <span class="va">self</span>._ensure_level_is_on_valid_range(</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>            level) <span class="cf">if</span> level <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> randint(<span class="dv">1</span>, <span class="dv">70</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.character_class: <span class="bu">str</span> <span class="op">=</span> <span class="va">self</span>._ensure_character_class_is_implemented(</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>            character_class <span class="kw">or</span> choice(GAME_CLASSES))</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gold: <span class="bu">float</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _ensure_level_is_on_valid_range(<span class="va">self</span>, value: Annotated[<span class="bu">int</span>, <span class="kw">lambda</span> x: <span class="dv">1</span> <span class="op">&lt;=</span> x <span class="op">&lt;=</span> <span class="dv">70</span>]) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (value <span class="op">&lt;</span> <span class="dv">1</span> <span class="kw">or</span> value <span class="op">&gt;</span> <span class="dv">70</span>):</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f&quot;The level </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss"> is not allowed, the system can handle levels between 1 and 70&quot;</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> value</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _ensure_character_class_is_implemented(<span class="va">self</span>, value: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> value.lower() <span class="kw">not</span> <span class="kw">in</span> GAME_CLASSES:</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f&quot;The character class </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss"> is not implemented on diablo 3&quot;</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> value</span></code></pre></div>
<p>Una clase sencilla con par de validaciones para nuestros argumentos y
nos va de lujo para empezar, de momento crear clases en python me
resulta un poco feo con respecto a otros lenguajes como PHP o C#</p>
<h2 id="loot-table-maestra-solo-con-origen-cofre">Loot table maestra
solo con origen cofre</h2>
<p>Como no quiero centrarme en los detalles al empezar un proyecto,
prefiero tener una base que pueda ser extensible a lo largo del mismo y
solo definir en principio, que el origen del loot sea la apertura de un
cofre. Como es extensible y todos usarán la misma estructura, añadir una
nueva key con otro origen como por ejemplo matar al jefe de una falla es
bastante trivial:</p>
<p>La estructura básica que quiero llevar a cabo es la siguiente:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>  <span class="er">&quot;&lt;ORIGEN&gt;&quot;:</span> <span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;&lt;TIPO&gt;&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;rolls&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;min&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;max&quot;</span><span class="fu">:</span> <span class="dv">3</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;entries&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span> <span class="er">#</span> <span class="er">Se</span> <span class="er">inicializa</span> <span class="er">vacio</span> <span class="er">ya</span> <span class="er">que</span> <span class="er">nuestro</span> <span class="er">sistema</span> <span class="er">de</span> <span class="er">loot</span> <span class="er">trabaja</span> <span class="er">de</span> <span class="er">forma</span> <span class="er">dinamica</span> <span class="er">con</span> <span class="er">la</span> <span class="er">reglas</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;rules&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;&lt;type_of_item&gt;&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">10</span><span class="fu">,</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">60</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span></code></pre></div>
<p>A traves de la clave <code>roll</code> estamos diciendole cuantas
veces generar el loot a la hora de abrir un cofe para añadir las
<code>entries</code> correspondientes, es decir, de forma aleatoria si
salen 2 rolls, se aplicara la generacion de items desde las plantillas
de equipamiento 2 veces.</p>
<p>Con la clave <code>rules</code> y su contenido crearemos una funcion
dinámica mas adelante que lea estos valores los cuales usara para
obtener los items de una rareza en particular, esto nos prepara el json
para que sea extensible y no tengamos que modificar nuestro código
base.</p>
<p>El peso es clave, lo explicaré mas adelante pero determina si un item
tiene mas prioridad <em>(peso)</em> que otro para salir a la hora de
realizar un roll, este <code>max_total_weight</code> determina que si la
cantidad es 10, la suma de los weight de cada item obtenido no podra
superar un total de 60 por lo que habria que generarlo de nuevo hasta
que no supere el maximo <em>(no suele pasar pero por mantener un
control)</em></p>
<p>Prometo que lo entenderás cuando apliquemos el calculo, aquí te dejo
nuestro <code>loot_table.json</code> final que define las reglas de
apertura de cofres:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="er">//</span> <span class="er">loot_table.json</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;CHEST&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;NORMAL&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;rolls&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;min&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;max&quot;</span><span class="fu">:</span> <span class="dv">3</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;entries&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;rules&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;normal_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">10</span><span class="fu">,</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">60</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;rare_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">45</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;BEAMING&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;rolls&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;min&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;max&quot;</span><span class="fu">:</span> <span class="dv">6</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;entries&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;rules&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;normal_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">15</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;magic_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">15</span><span class="fu">,</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">50</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;rare_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">30</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;legendary_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">15</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;character_set_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">5</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;DIABOLIC&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;rolls&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;min&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">,</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;max&quot;</span><span class="fu">:</span> <span class="dv">10</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;entries&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;rules&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;magic_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">10</span><span class="fu">,</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">30</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;rare_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">20</span><span class="fu">,</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">75</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;legendary_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">10</span><span class="fu">,</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">55</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;character_set_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">20</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>In crescendo, mientras mas valioso el cofre, mas valioso los items
que pueden salir de el, así mantenemos un balance aunque esto, como ya
veremos en el código final, es lo mas díficil del sistema ya nunca
llueve a gusto de todos y alcanzar un meta estable es casi
imposible.</p>
<h1 id="sentando-las-bases-en-loot.py">Sentando las bases en
loot.py</h1>
<p>Vamos a empezar definiendo bases sencillas en el core de nuestro
sistema, vamos a precargar nuestra tabla maestra para usarla a través de
nuestras funciones.</p>
<p><em>Siempre tengo en cuenta que el fichero <code>loot.py</code> va a
estar en la raiz del proyecto a la hora de definir los paths cuando se
trata de manejar archivos</em></p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Annotated</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> random <span class="im">import</span> randint, random, randrange, shuffle, choice</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> character <span class="im">import</span> Character, GAME_CLASSES</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;data/loot_table.json&#39;</span>, <span class="st">&#39;r&#39;</span>) <span class="im">as</span> loot_table:</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    AVAILABLE_POOLS <span class="op">=</span> json.load(loot_table)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> start_loot(character: Character, origin: <span class="bu">str</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    selected_pool: <span class="bu">dict</span> <span class="op">=</span> build_pool(character, origin)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [{}]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_pool(character: Character, origin: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    pool_template: <span class="bu">dict</span> <span class="op">=</span> AVAILABLE_POOLS.copy()</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    translated_origin: <span class="bu">list</span>[<span class="bu">str</span>] <span class="op">=</span> origin.upper().split(<span class="st">&#39;.&#39;</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> translated_origin:</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">in</span> pool_template:</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            pool_template <span class="op">=</span> pool_template[key]</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">KeyError</span>(</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f&quot;The access key </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> does not exists in the available pools for the value </span><span class="sc">{</span>origin<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pool_template</span></code></pre></div>
<p>De momento tenemos precargado nuestra tabla maestra en la variable
<code>AVAILABLE_POOLS</code> y 2 funciones principales que se encargan
de obtener el pool adecuado segun el origen que queremos simular y el
personaje.</p>
<p>A menos que explicitamente quiera mutar el pool, vamos a manejar una
copia para no alterar el original. Como la variable origin que
recibiremos vendra en el formato <code>chest.normal</code> o
<code>chest.diabolic</code> tenemos que aplicar una transformación para
convertirlo en una lista tipo <code>['CHEST', 'NORMAL']</code> lo que
nos permitira acceder al pool de una forma dinámica:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>    pool_template: <span class="bu">dict</span> <span class="op">=</span> AVAILABLE_POOLS.copy()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    translated_origin: <span class="bu">list</span>[<span class="bu">str</span>] <span class="op">=</span> origin.upper().split(<span class="st">&#39;.&#39;</span>)</span></code></pre></div>
<p>Gracias a esto, podemos usar el siguiente bucle for para seleccionar
el pool:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> translated_origin:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">in</span> pool_template:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>            pool_template <span class="op">=</span> pool_template[key]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">KeyError</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f&quot;The access key </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> does not exists in the available pools for the value </span><span class="sc">{</span>origin<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pool_template</span></code></pre></div>
<p>Para un valor de <code>chest.normal</code> deberia devolvernos el
diccionario:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;rolls&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;min&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;max&quot;</span><span class="fu">:</span> <span class="dv">3</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;entries&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;rules&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;normal_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">10</span><span class="fu">,</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">60</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">},</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;rare_equipment&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;amount&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;max_total_weight&quot;</span><span class="fu">:</span> <span class="dv">45</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="er">,</span></span></code></pre></div>
<h2 id="cargando-items-en-el-pool-seleccionado">Cargando items en el
pool seleccionado</h2>
<p>El código anterior nos proporciona el template para el origen
seleccionado pero no tenemos cargada ninguna entry donde se alojaran los
items que se pueden lootear, vamos a crear una nueva función para que
cargue las entries según las reglas definidas en el pool:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Antes vamos a definir el diccionario GAME_ITEMS muy simple de forma global en el script</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>GAME_ITEMS: <span class="bu">dict</span> <span class="op">=</span> {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;NORMAL_EQUIPMENT&quot;</span>: [</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>       {</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;quantity&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;name&quot;</span>: <span class="st">&quot;Star Helm&quot;</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span>: <span class="st">&quot;armor:helm&quot;</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;rarity&quot;</span>: <span class="st">&quot;normal&quot;</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;stats_value_range&quot;</span>: { <span class="st">&quot;min&quot;</span>: <span class="dv">21</span>, <span class="st">&quot;max&quot;</span>: <span class="dv">24</span> },</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;weight&quot;</span>: <span class="fl">4.05</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;drop&quot;</span>: { <span class="st">&quot;chance&quot;</span>: <span class="fl">0.46881700267124105</span>, <span class="st">&quot;max_chance&quot;</span>: <span class="fl">0.5625804032054893</span> }</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>      {</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;quantity&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;name&quot;</span>: <span class="st">&quot;Leather Hood&quot;</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span>: <span class="st">&quot;armor:helm&quot;</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;rarity&quot;</span>: <span class="st">&quot;normal&quot;</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;stats_value_range&quot;</span>: { <span class="st">&quot;min&quot;</span>: <span class="dv">21</span>, <span class="st">&quot;max&quot;</span>: <span class="dv">24</span> },</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;weight&quot;</span>: <span class="fl">6.44</span>,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;drop&quot;</span>: { <span class="st">&quot;chance&quot;</span>: <span class="fl">0.5196764901634326</span>, <span class="st">&quot;max_chance&quot;</span>: <span class="fl">0.6236117881961192</span> }</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  ],</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;RARE_EQUIPMENT&quot;</span>: ...</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>La estructura que he decidido para los items del juego es esta, ya
empezamos a ver porcentajes de drop y el famoso valor weight que define
el peso que tendra este item en la lista completa. Estos valores los
genero en <code>scrapper.py</code> pero de momento no te preocupes y
definamos el diccionario manualmente para una vez confirmada nuestra
lógica podamos usar archivos .json que nos ayudaran a este
propósito.</p>
<p>La siguiente función es la que utilizara este diccionario
<code>GAME_ITEMS</code> y nos ayudará a cargar usando las claves de
<code>rules</code> en el pool que hemos obtenido anteriormente y que
casualmente son la rareza del equipamiento.</p>
<p>He decidido cargarlas directamente en el pool en lugar de devolver la
lista y asignarla despues para evitarme acciones adicionales ademas de
que el pool que estamos pasando como parámetro es una copia del
original:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_item_entries_based_on_pool_rules(selected_pool: <span class="bu">dict</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    key: <span class="bu">str</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> selected_pool[<span class="st">&#39;rules&#39;</span>].keys():</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        equipment_rarity <span class="op">=</span> key.strip().upper()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> equipment_rarity <span class="kw">in</span> GAME_ITEMS:</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            items <span class="op">=</span> GAME_ITEMS[equipment_rarity].copy()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            amount_rule <span class="op">=</span> selected_pool[<span class="st">&#39;rules&#39;</span>][key][<span class="st">&#39;amount&#39;</span>]</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            shuffle(items)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>            selected_pool[<span class="st">&#39;entries&#39;</span>] <span class="op">+=</span> items[:amount_rule]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> selected_pool</span></code></pre></div>
<p>Esto es el archivo <code>loot.py</code> que hemos conseguido
desarrollar hasta ahora:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loot.py</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> json <span class="im">import</span> load</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;data/loot_table.json&#39;</span>, <span class="st">&#39;r&#39;</span>) <span class="im">as</span> loot_table:</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    AVAILABLE_POOLS <span class="op">=</span> json.load(loot_table)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>GAME_ITEMS: <span class="bu">dict</span> <span class="op">=</span> {</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>   <span class="st">&quot;NORMAL_EQUIPMENT&quot;</span>: [</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>       {</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;quantity&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;name&quot;</span>: <span class="st">&quot;Star Helm&quot;</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span>: <span class="st">&quot;armor:helm&quot;</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;rarity&quot;</span>: <span class="st">&quot;normal&quot;</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;stats_value_range&quot;</span>: { <span class="st">&quot;min&quot;</span>: <span class="dv">21</span>, <span class="st">&quot;max&quot;</span>: <span class="dv">24</span> },</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;weight&quot;</span>: <span class="fl">4.05</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;drop&quot;</span>: { <span class="st">&quot;chance&quot;</span>: <span class="fl">0.46881700267124105</span>, <span class="st">&quot;max_chance&quot;</span>: <span class="fl">0.5625804032054893</span> }</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>      {</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;quantity&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;name&quot;</span>: <span class="st">&quot;Leather Hood&quot;</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;type&quot;</span>: <span class="st">&quot;armor:helm&quot;</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;rarity&quot;</span>: <span class="st">&quot;normal&quot;</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;stats_value_range&quot;</span>: { <span class="st">&quot;min&quot;</span>: <span class="dv">21</span>, <span class="st">&quot;max&quot;</span>: <span class="dv">24</span> },</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;weight&quot;</span>: <span class="fl">6.44</span>,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;drop&quot;</span>: { <span class="st">&quot;chance&quot;</span>: <span class="fl">0.5196764901634326</span>, <span class="st">&quot;max_chance&quot;</span>: <span class="fl">0.6236117881961192</span> }</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  ],</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;RARE_EQUIPMENT&quot;</span>: []</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> start_loot(character: Character, origin: <span class="bu">str</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    selected_pool: <span class="bu">dict</span> <span class="op">=</span> build_pool(character, origin)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [{}]</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_pool(character: Character, origin: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    pool_template: <span class="bu">dict</span> <span class="op">=</span> AVAILABLE_POOLS.copy()</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    translated_origin: <span class="bu">list</span>[<span class="bu">str</span>] <span class="op">=</span> origin.upper().split(<span class="st">&#39;.&#39;</span>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> translated_origin:</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">in</span> pool_template:</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>            pool_template <span class="op">=</span> pool_template[key]</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">KeyError</span>(</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f&quot;The access key </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> does not exists in the available pools for the value </span><span class="sc">{</span>origin<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> load_item_entries_based_on_pool_rules(pool_template)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_item_entries_based_on_pool_rules(selected_pool: <span class="bu">dict</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    key: <span class="bu">str</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> selected_pool[<span class="st">&#39;rules&#39;</span>].keys():</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>        equipment_rarity <span class="op">=</span> key.strip().upper()</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> equipment_rarity <span class="kw">in</span> GAME_ITEMS:</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>            items <span class="op">=</span> GAME_ITEMS[equipment_rarity].copy()</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>            amount_rule <span class="op">=</span> selected_pool[<span class="st">&#39;rules&#39;</span>][key][<span class="st">&#39;amount&#39;</span>]</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>            shuffle(items)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>            selected_pool[<span class="st">&#39;entries&#39;</span>] <span class="op">+=</span> items[:amount_rule]</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> selected_pool</span></code></pre></div>
<h2 id="seleccionando-items-en-base-a-su-peso">Seleccionando items en
base a su peso</h2>
<p>Una vez hemos obtenido una cantidad aleatorio del inventario global
para el pool debemos aplicar el calculo del peso para ver que items de
esa lista se extraen para su posterior calculo del drop.</p>
<p>Te preguntarás porque no extraemos directamente los items con el
calculo del weight y nos evitamos ese shuffle inicial, te explico la
causa en los siguientes bloques de código mostrando el cálculo del
weight:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>total_weight <span class="op">=</span> <span class="bu">sum</span>([entry[<span class="st">&#39;weight&#39;</span>] <span class="cf">for</span> entry <span class="kw">in</span> pool[<span class="st">&#39;entries&#39;</span>]])</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtenenmos la probabilidad de un item individual en base al peso total de la lista en la que se encuentra</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>probability <span class="op">=</span> item[<span class="st">&#39;weight&#39;</span>] <span class="op">/</span> total_weight</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Para luego aplicar el calculo de probabilidad y determinar si aparece</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> random() <span class="op">&lt;=</span> probability:</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># //...</span></span></code></pre></div>
<p>Si la lista de items normales fuera grande, pongamos que obtenemos un
total_weight de 500, para un item individual la probabilidad se
reduciria muchisimo y no saldría casí nunca incluso tratándose de un
objeto normal con un drop alto en el juego:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>probability <span class="op">=</span> <span class="fl">2.54</span> <span class="op">/</span> <span class="dv">500</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fl">0.00508</span></span></code></pre></div>
<p>Si en cambio lo aplicamos con los items extraidos aleatoriamente de
nuestra funcion llamada
<code>load_item_entries_based_on_pool_rules</code> en la que para un
pool de <code>chest.normal</code> extraemos 10 items de rareza normal
donde el total_weight resultante es 25 tendriamos un 18% de
probabilidades de que aparezca para un item individual con peso 4.5:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>probability <span class="op">=</span> <span class="fl">4.5</span> <span class="op">/</span> <span class="dv">25</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fl">0.18</span></span></code></pre></div>
<h3 id="creando-la-función-que-aplica-el-calculo-de-weight">Creando la
función que aplica el calculo de weight</h3>
<p>Inmediatamente despues de seleccionar el pool, debemos aplicar el
calculo del weight para ver que items serán candidatos para
posteriormente aplicar el drop chance.</p>
<p>Para darle dinamismo al cálculo entra en juego <strong>el número de
rolls que puede aparecer en el origen seleccionado</strong> por lo que
debemos pasarle como parámetro el pool seleccionado a la función y no
solo la parte de ‘entries’.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> choose_items_with_weight_calculation(pool: Dict) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    number_of_rolls <span class="op">=</span> randint(pool[<span class="st">&#39;rolls&#39;</span>][<span class="st">&#39;min&#39;</span>], pool[<span class="st">&#39;rolls&#39;</span>][<span class="st">&#39;max&#39;</span>]) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    total_weight <span class="op">=</span> <span class="bu">sum</span>([entry[<span class="st">&#39;weight&#39;</span>] <span class="cf">for</span> entry <span class="kw">in</span> pool[<span class="st">&#39;entries&#39;</span>]])</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(number_of_rolls):</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> pool[<span class="st">&#39;entries&#39;</span>]:</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>            probability <span class="op">=</span> item[<span class="st">&#39;weight&#39;</span>] <span class="op">/</span> total_weight</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ¿quitar de la lista una vez añadido para evitar duplicados, o generar duplicados a proposito?</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> random() <span class="op">&lt;=</span> probability:</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>                result.append(item)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code></pre></div>
<p>Así se nos va quedando la función <code>start_loot</code>:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> start_loot(character: Character, origin: <span class="bu">str</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    selected_pool: <span class="bu">dict</span> <span class="op">=</span> build_pool(character, origin)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    selected_items: List[Dict] <span class="op">=</span> choose_items_with_weight_calculation(selected_pool)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [{}]</span></code></pre></div>
<h2 id="cálculo-del-drop-para-cada-item">Cálculo del drop para cada
item</h2>
<p>Esta funcionalidad se puede complicar todo lo que quieras, yo he
decidido implementar la posibilidad de aplicar modificadores al
porcentaje los cuales pueden venir de cualquier tipo de movida en el
juego, ya sea por modificadores globales del sistema, equipamiento del
personaje, etc. Nosotros no queremos tener en cuenta el detalle de su
origen, solo su aplicación en el cálculo actual.</p>
<p>Para tener un control y mantener un ‘equilibrio’ en el sistema de
loot, hemos definido un máximo para cada item que no puede sobrepasarse
por muchos buff que tenga el personaje.</p>
<p>Se aprovecha también este momento para generar la estadística base
del item en el rango propuesto, si fuera un arma esto representaría el
daño, para una armadura la defensa, etc.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_drop_chance(items: List[Dict], modifier: Annotated[<span class="bu">float</span>, <span class="kw">lambda</span> x: <span class="fl">0.0</span> <span class="op">&lt;=</span> x <span class="op">&lt;=</span> <span class="fl">1.0</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    safe_items <span class="op">=</span> items.copy()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> safe_items:</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        chance <span class="op">=</span> item[<span class="st">&#39;drop&#39;</span>][<span class="st">&#39;chance&#39;</span>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        max_chance <span class="op">=</span> item[<span class="st">&#39;drop&#39;</span>][<span class="st">&#39;max_chance&#39;</span>]</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        final_chance <span class="op">=</span> chance</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> modifier <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>            new_chance <span class="op">=</span> chance <span class="op">+</span> modifier</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>            final_chance <span class="op">=</span> new_chance <span class="cf">if</span> new_chance <span class="op">&lt;</span> max_chance <span class="cf">else</span> max_chance</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> random() <span class="op">&lt;=</span> final_chance:</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>            item[<span class="st">&#39;stat_value&#39;</span>] <span class="op">=</span> randint(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>                item[<span class="st">&#39;stats_value_range&#39;</span>][<span class="st">&#39;min&#39;</span>],  item[<span class="st">&#39;stats_value_range&#39;</span>][<span class="st">&#39;max&#39;</span>])</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>            result.append(item)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code></pre></div>
<p>Los porcentajes en este script se manejan entre los valores 0 y 1
donde 0.05 -&gt; 5% y 1 -&gt; 100%. Esto lo hago porque las funciones
random de python funcionan con rangos decimales entre 0 y 1 por lo que
la implementación se hace mas natural.</p>
<p>Por cuestiones logísticas estoy pasando hard codeado el valor del
modificador que podría ser None o venir de otra fuente externa, veamos
como es el estado actual de nuestra función principal
<code>start_loot</code>:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> start_loot(character: Character, origin: <span class="bu">str</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    selected_pool: <span class="bu">dict</span> <span class="op">=</span> build_pool(character, origin)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    selected_items: List[Dict] <span class="op">=</span> choose_items_with_weight_calculation(selected_pool)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    dropped_items <span class="op">=</span> apply_drop_chance(selected_items, <span class="fl">0.05</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [{<span class="st">&quot;items&quot;</span>: dropped_items}]</span></code></pre></div>
<h1 id="scrapper-para-generar-nuestros-archivos-.json">Scrapper para
generar nuestros archivos .json</h1>
<p>Para una simulación mas realista he decidido pillarme los items de
armadura solamente, el procedimiento para las armas es el mismo pero no
necesito tantos detalles para la versión inicial de este script.</p>
<h2 id="generar-archivos-.json-de-equipamiento">Generar archivos .json
de equipamiento</h2>
<p>Como este artículo se expandiría infinito explicando el scrapping, te
dejo aquí el código y puedas generar los archivos .json actualizados en
lugar de cogerlos del repositorio:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests_cache</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shutil <span class="im">import</span> rmtree</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> random <span class="im">import</span> uniform</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> json <span class="im">import</span> dump, load, JSONDecodeError</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> os <span class="im">import</span> makedirs, path</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4.element <span class="im">import</span> Tag</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>base_url: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;https://us.diablo3.blizzard.com/en-us&quot;</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>requests_cache.install_cache(</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    backend<span class="op">=</span><span class="st">&#39;filesystem&#39;</span>, serializer<span class="op">=</span><span class="st">&#39;json&#39;</span>, cache_name<span class="op">=</span><span class="st">&#39;scrapper-cache&#39;</span>, expire_after<span class="op">=</span><span class="dv">3600</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>CURRENT_DIR <span class="op">=</span> path.dirname(path.abspath(<span class="va">__file__</span>))</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>DATA_DIRECTORY <span class="op">=</span> path.join(CURRENT_DIR, <span class="st">&#39;..&#39;</span>, <span class="st">&#39;data&#39;</span>, <span class="st">&#39;equipment&#39;</span>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_items_information(base_url: <span class="bu">str</span>, category: <span class="bu">str</span>):</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    item_page <span class="op">=</span> base_url <span class="op">+</span> <span class="ss">f&quot;/item/</span><span class="sc">{</span>category<span class="sc">}</span><span class="ss">/&quot;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(item_page)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        response.raise_for_status()</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>        scrapper <span class="op">=</span> BeautifulSoup(response.text, <span class="st">&quot;html.parser&quot;</span>)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        items <span class="op">=</span> scrapper.find_all(<span class="kw">lambda</span> tag: tag.name <span class="op">==</span> <span class="st">&#39;tr&#39;</span> <span class="kw">and</span> (<span class="st">&#39;row1&#39;</span> <span class="kw">in</span> tag.get(<span class="st">&#39;class&#39;</span>, []) <span class="kw">or</span> <span class="st">&#39;row2&#39;</span> <span class="kw">in</span> tag.get(</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;class&#39;</span>, [])))</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> {}</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> items:</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>            name: <span class="bu">str</span> <span class="op">=</span> extract_item_name(item)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>            rarity: <span class="bu">str</span> <span class="op">=</span> extract_item_rarity(item)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>            armor_range: <span class="bu">dict</span> <span class="op">=</span> extract_item_armor_range(item, category)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>            item_build <span class="op">=</span> {<span class="st">&quot;quantity&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;name&quot;</span>: name,</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;type&quot;</span>: <span class="ss">f&quot;armor:</span><span class="sc">{</span>category<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;rarity&quot;</span>: rarity,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;stats_value_range&quot;</span>: armor_range,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;weight&quot;</span>: generate_weight_based_on_rarity(rarity),</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&quot;drop&quot;</span>: generate_drop_chance_based_on_rarity(rarity)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>                          }</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> rarity <span class="kw">in</span> result:</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>                result[rarity].append(item_build)</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>                result[rarity] <span class="op">=</span> [item_build]</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> rarity <span class="kw">in</span> result.keys():</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>            equipment_filename <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>rarity<span class="sc">}</span><span class="ss">_equipment.json&quot;</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> path.exists(<span class="ss">f&quot;</span><span class="sc">{</span>DATA_DIRECTORY<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>equipment_filename<span class="sc">}</span><span class="ss">&quot;</span>):</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>                <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f&quot;</span><span class="sc">{</span>DATA_DIRECTORY<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>equipment_filename<span class="sc">}</span><span class="ss">&quot;</span>, <span class="st">&#39;r+&#39;</span>) <span class="im">as</span> existing_equipment_file:</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>                        actual_content <span class="op">=</span> load(existing_equipment_file)</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> JSONDecodeError:</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>                        actual_content <span class="op">=</span> []</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Mover el puntero al principio del archivo</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>                    existing_equipment_file.seek(<span class="dv">0</span>)</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Borrar todo el contenido existente del archivo</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>                    existing_equipment_file.truncate()</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>                    dump(actual_content <span class="op">+</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>                         result[rarity], existing_equipment_file)</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">with</span> <span class="bu">open</span>(<span class="ss">f&quot;</span><span class="sc">{</span>DATA_DIRECTORY<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>equipment_filename<span class="sc">}</span><span class="ss">&quot;</span>, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> equipment_file:</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>                    dump(result[rarity], equipment_file)</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> requests.exceptions.HTTPError <span class="im">as</span> error:</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Error HTTP: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>        exit()</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_item_name(item: Tag) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> item.find(<span class="st">&quot;h3&quot;</span>, class_<span class="op">=</span><span class="st">&quot;subheader-3&quot;</span>).find(<span class="st">&#39;a&#39;</span>).text</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_item_rarity(item: Tag) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> {</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;d3-color-orange&#39;</span>: <span class="st">&#39;legendary&#39;</span>,</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;d3-color-yellow&#39;</span>: <span class="st">&#39;rare&#39;</span>,</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;d3-color-blue&#39;</span>: <span class="st">&#39;magic&#39;</span>,</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;d3-color-white&#39;</span>: <span class="st">&#39;normal&#39;</span>,</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;d3-color-green&#39;</span>: <span class="st">&#39;character_set&#39;</span></span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> color, rarity <span class="kw">in</span> colors.items():</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> item.find(<span class="st">&#39;a&#39;</span>, {<span class="st">&#39;class&#39;</span>: color}):</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> rarity</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;unknown&#39;</span></span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_item_armor_range(item: Tag, category: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> category <span class="kw">not</span> <span class="kw">in</span> [<span class="st">&#39;amulet&#39;</span>, <span class="st">&#39;ring&#39;</span>]:</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>        armor_range <span class="op">=</span> item.find(</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;ul&#39;</span>, {<span class="st">&quot;class&quot;</span>: <span class="st">&#39;item-armor-armor&#39;</span>}).find(<span class="st">&#39;span&#39;</span>, {<span class="st">&quot;class&quot;</span>: <span class="st">&#39;value&#39;</span>}).text</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>        match <span class="op">=</span> re.search(<span class="vs">r&#39;(\d+)\s*-\s*(\d+)&#39;</span>, armor_range.strip())</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> match:</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {<span class="st">&#39;min&#39;</span>: <span class="bu">int</span>(match.group(<span class="dv">1</span>)), <span class="st">&#39;max&#39;</span>: <span class="bu">int</span>(match.group(<span class="dv">2</span>))}</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;min&quot;</span>: <span class="dv">0</span>, <span class="st">&quot;max&quot;</span>: <span class="dv">0</span>}</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_weight_based_on_rarity(rarity: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>    weight_table <span class="op">=</span> {</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;normal&quot;</span>: {<span class="st">&quot;min&quot;</span>: <span class="dv">1</span>, <span class="st">&quot;max&quot;</span>: <span class="dv">7</span>},</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;magic&quot;</span>: {<span class="st">&quot;min&quot;</span>: <span class="dv">1</span>, <span class="st">&quot;max&quot;</span>: <span class="dv">5</span>},</span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;rare&quot;</span>: {<span class="st">&quot;min&quot;</span>: <span class="dv">1</span>, <span class="st">&quot;max&quot;</span>: <span class="dv">3</span>},</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;legendary&quot;</span>: {<span class="st">&quot;min&quot;</span>: <span class="dv">1</span>, <span class="st">&quot;max&quot;</span>: <span class="dv">3</span>},</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;character_set&quot;</span>: {<span class="st">&quot;min&quot;</span>: <span class="dv">1</span>, <span class="st">&quot;max&quot;</span>: <span class="fl">2.5</span>},</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rarity <span class="kw">in</span> weight_table.keys():</span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">round</span>(uniform(weight_table[rarity][<span class="st">&quot;min&quot;</span>], weight_table[rarity][<span class="st">&quot;max&quot;</span>]), <span class="dv">2</span>)</span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_drop_chance_based_on_rarity(rarity: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>    drop_chance_table <span class="op">=</span> {</span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;normal&quot;</span>: {<span class="st">&quot;min&quot;</span>: <span class="fl">0.45</span>, <span class="st">&quot;max&quot;</span>: <span class="fl">0.7</span>, <span class="st">&quot;max_allowed_percentage&quot;</span>: <span class="fl">0.20</span>},</span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;magic&quot;</span>: {<span class="st">&quot;min&quot;</span>: <span class="fl">0.35</span>, <span class="st">&quot;max&quot;</span>: <span class="fl">0.45</span>, <span class="st">&quot;max_allowed_percentage&quot;</span>: <span class="fl">0.15</span>},</span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;rare&quot;</span>: {<span class="st">&quot;min&quot;</span>: <span class="fl">0.25</span>, <span class="st">&quot;max&quot;</span>: <span class="fl">0.3</span>, <span class="st">&quot;max_allowed_percentage&quot;</span>: <span class="fl">0.10</span>},</span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;legendary&quot;</span>: {<span class="st">&quot;min&quot;</span>: <span class="fl">0.01</span>, <span class="st">&quot;max&quot;</span>: <span class="fl">0.09</span>, <span class="st">&quot;max_allowed_percentage&quot;</span>: <span class="fl">0.05</span>},</span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;character_set&quot;</span>:  {<span class="st">&quot;min&quot;</span>: <span class="fl">0.01</span>, <span class="st">&quot;max&quot;</span>: <span class="fl">0.09</span>, <span class="st">&quot;max_allowed_percentage&quot;</span>: <span class="fl">0.05</span>},</span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rarity <span class="kw">in</span> drop_chance_table.keys():</span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a>        base_chance <span class="op">=</span> uniform(</span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a>            drop_chance_table[rarity][<span class="st">&quot;min&quot;</span>], drop_chance_table[rarity][<span class="st">&quot;max&quot;</span>])</span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&quot;chance&quot;</span>: base_chance, <span class="st">&quot;max_chance&quot;</span>: base_chance <span class="op">+</span> (base_chance <span class="op">*</span> drop_chance_table[rarity][<span class="st">&#39;max_allowed_percentage&#39;</span>])}</span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;chance&quot;</span>: <span class="dv">0</span>, <span class="st">&quot;max_chance&quot;</span>: <span class="dv">0</span>}</span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_equipment_information():</span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> path.exists(DATA_DIRECTORY):</span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>        rmtree(DATA_DIRECTORY)</span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a>    makedirs(DATA_DIRECTORY, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> equipment <span class="kw">in</span> [<span class="st">&#39;helm&#39;</span>, <span class="st">&#39;pauldrons&#39;</span>, <span class="st">&#39;chest-armor&#39;</span>, <span class="st">&#39;bracers&#39;</span>, <span class="st">&#39;gloves&#39;</span>, <span class="st">&#39;belt&#39;</span>, <span class="st">&#39;pants&#39;</span>, <span class="st">&#39;boots&#39;</span>, <span class="st">&#39;amulet&#39;</span>, <span class="st">&#39;ring&#39;</span>]:</span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Extracting data for </span><span class="sc">{</span>equipment<span class="sc">}</span><span class="ss">...&quot;</span>)</span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a>        extract_items_information(base_url, equipment)</span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a>extract_equipment_information()</span></code></pre></div>
<h2 id="precarga-de-los-archivos-en-loot.py">Precarga de los archivos en
loot.py</h2>
<p>Si recuerdas el principio del script <code>loot.py</code> teniamos
puesto a mano el diccionario de <code>GAME_ITEMS</code>, vamos añadir un
par de lineas para precargar los json generados con el scrapper.</p>
<p>Con la palabra <code>with</code> aseguramos que el fichero se cierra
correctamente, <code>with</code> se utiliza para trabajar con recursos
que deben ser liberados después de su uso, como archivos o conexiones de
red:</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>GAME_ITEMS: <span class="bu">dict</span> <span class="op">=</span> {}</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;data/equipment/legendary_equipment.json&#39;</span>, <span class="st">&#39;r&#39;</span>) <span class="im">as</span> legendary_equipment:</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    GAME_ITEMS[<span class="st">&#39;LEGENDARY_EQUIPMENT&#39;</span>] <span class="op">=</span> json.load(legendary_equipment)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;data/equipment/rare_equipment.json&#39;</span>, <span class="st">&#39;r&#39;</span>) <span class="im">as</span> rare_equipment:</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    GAME_ITEMS[<span class="st">&#39;RARE_EQUIPMENT&#39;</span>] <span class="op">=</span> json.load(rare_equipment)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;data/equipment/magic_equipment.json&#39;</span>, <span class="st">&#39;r&#39;</span>) <span class="im">as</span> magic_equipment:</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    GAME_ITEMS[<span class="st">&#39;MAGIC_EQUIPMENT&#39;</span>] <span class="op">=</span> json.load(magic_equipment)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;data/equipment/normal_equipment.json&#39;</span>, <span class="st">&#39;r&#39;</span>) <span class="im">as</span> normal_equipment:</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    GAME_ITEMS[<span class="st">&#39;NORMAL_EQUIPMENT&#39;</span>] <span class="op">=</span> json.load(normal_equipment)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;data/equipment/character_set_equipment.json&#39;</span>, <span class="st">&#39;r&#39;</span>) <span class="im">as</span> character_set_equipment:</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    GAME_ITEMS[<span class="st">&#39;CHARACTER_SET_EQUIPMENT&#39;</span>] <span class="op">=</span> json.load(character_set_equipment)</span></code></pre></div>
<h1 id="no-nos-olvidemos-del-oro">No nos olvidemos del oro</h1>
<p>Ahora que tenemos la base de nuestra generación de loot podemos ir
añadiendole mas cosas como es el oro, si has jugado diablo a veces
aparece oro por no decir casi siempre, así que vamos a implementar una
funcionalidad sencilla para generar pequeñas cantidades en cada
iteración:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> start_loot(character: Character, origin: <span class="bu">str</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    selected_pool: <span class="bu">dict</span> <span class="op">=</span> build_pool(character, origin)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    selected_items <span class="op">=</span> choose_items_with_weight_calculation(selected_pool)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    dropped_items <span class="op">=</span> apply_drop_chance(selected_items, <span class="fl">0.05</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    gold <span class="op">=</span> randrange(<span class="dv">10000</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [{<span class="st">&quot;items&quot;</span>: dropped_items, <span class="st">&quot;gold&quot;</span>: gold}]</span></code></pre></div>
<h1 id="gemas-everywhere">Gemas everywhere</h1>
<p>Aparte de equipamiento y oro a veces aparecen gemas, pero estas
tienen condiciones especiales segun el nivel del personaje y la
dificultad en la que juegue y no salen todos los tipos como pueden ser
Real y Real sin defectos que es el máximo rango que puede alcanzar.</p>
<p>Mi enfoque inicial es como no, crear un archivo
<code>gems.json</code> que me sirva de plantilla en la generación:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;NORMAL&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;TYPES&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;AMETHYST&quot;</span><span class="ot">,</span> <span class="st">&quot;DIAMOND&quot;</span><span class="ot">,</span> <span class="st">&quot;EMERALD&quot;</span><span class="ot">,</span> <span class="st">&quot;RUBY&quot;</span><span class="ot">,</span> <span class="st">&quot;TOPAZ&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;CATEGORY&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FLAWLESS&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;drop&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;min_level&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;chance&quot;</span><span class="fu">:</span> <span class="fl">0.25</span><span class="fu">,</span> <span class="dt">&quot;max_chance&quot;</span><span class="fu">:</span> <span class="fl">0.3</span> <span class="fu">}</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;SQUARE&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;drop&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;min_level&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;chance&quot;</span><span class="fu">:</span> <span class="fl">0.23</span><span class="fu">,</span> <span class="dt">&quot;max_chance&quot;</span><span class="fu">:</span> <span class="fl">0.27</span> <span class="fu">}</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FLAWLESS SQUARE&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;drop&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;min_level&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;chance&quot;</span><span class="fu">:</span> <span class="fl">0.21</span><span class="fu">,</span> <span class="dt">&quot;max_chance&quot;</span><span class="fu">:</span> <span class="fl">0.24</span> <span class="fu">}</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;STAR&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;drop&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;min_level&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span> <span class="dt">&quot;chance&quot;</span><span class="fu">:</span> <span class="fl">0.2</span><span class="fu">,</span> <span class="dt">&quot;max_chance&quot;</span><span class="fu">:</span> <span class="fl">0.22</span> <span class="fu">}</span> <span class="fu">},</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;MARQUISE&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;drop&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;min_level&quot;</span><span class="fu">:</span> <span class="dv">61</span><span class="fu">,</span> <span class="dt">&quot;chance&quot;</span><span class="fu">:</span> <span class="fl">0.13</span><span class="fu">,</span> <span class="dt">&quot;max_chance&quot;</span><span class="fu">:</span> <span class="fl">0.16</span> <span class="fu">}</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;IMPERIAL&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;drop&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;min_level&quot;</span><span class="fu">:</span> <span class="dv">61</span><span class="fu">,</span> <span class="dt">&quot;chance&quot;</span><span class="fu">:</span> <span class="fl">0.15</span><span class="fu">,</span> <span class="dt">&quot;max_chance&quot;</span><span class="fu">:</span> <span class="fl">0.18</span> <span class="fu">}</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FLAWLESS IMPERIAL&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;drop&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;min_level&quot;</span><span class="fu">:</span> <span class="dv">61</span><span class="fu">,</span> <span class="dt">&quot;chance&quot;</span><span class="fu">:</span> <span class="fl">0.08</span><span class="fu">,</span> <span class="dt">&quot;max_chance&quot;</span><span class="fu">:</span> <span class="fl">0.1</span> <span class="fu">}</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;ROYAL&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;drop&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;min_level&quot;</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span> <span class="dt">&quot;chance&quot;</span><span class="fu">:</span> <span class="fl">0.02</span><span class="fu">,</span> <span class="dt">&quot;max_chance&quot;</span><span class="fu">:</span> <span class="fl">0.03</span> <span class="fu">}</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;FLAWLESS ROYAL&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;drop&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;min_level&quot;</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span> <span class="dt">&quot;chance&quot;</span><span class="fu">:</span> <span class="fl">0.01</span><span class="fu">,</span> <span class="dt">&quot;max_chance&quot;</span><span class="fu">:</span> <span class="fl">0.02</span> <span class="fu">}</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;LEGENDARY&quot;</span><span class="fu">:</span> <span class="er">None</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>Para evitar que salgan <code>ROYAL</code> y
<code>FLAWLESS ROYAL</code> he puesto un nivel que el sistema no permite
y me evito complicaciones innecesarias. Las legendarias necesitaran de
otras reglas como haber terminado una falla superior con ciertas
condiciones, para no complicarme ya que quiero hacer otras cosas con mi
vida las he dejado a None y que las implemente otro insensato.</p>
<h2 id="aplicando-el-drop-chance-para-las-gemas">Aplicando el drop
chance para las gemas</h2>
<p>Al ser un número muy reducido con unas características específicas
podemos aplicar el drop directamente a la hora de lootearlas.</p>
<p>Creemos una variable global al principio de nuestro script que
referencie nuestro archivo <code>gems.json</code>:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;data/gems/gems.json&#39;</span>, <span class="st">&#39;r&#39;</span>) <span class="im">as</span> gems:</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    GAME_ITEMS[<span class="st">&#39;GEMS&#39;</span>] <span class="op">=</span> json.load(gems)</span></code></pre></div>
<p>Y aplicamos una lógica muy parecida a las anteriores con la
posibilidad de aplicar modificares al porcentaje de drop, cada vez que
la miro veo que se puede mejorar pero me da una pereza de cojones:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loot_gems(character: Character, modifier: Annotated[<span class="bu">float</span>, <span class="kw">lambda</span> x: <span class="fl">0.0</span> <span class="op">&lt;=</span> x <span class="op">&lt;=</span> <span class="fl">1.0</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    available_gems <span class="op">=</span> GAME_ITEMS[<span class="st">&#39;GEMS&#39;</span>].copy()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    looted_gems <span class="op">=</span> []</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    max_quantity <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> character.level <span class="op">&gt;=</span> <span class="dv">61</span>:</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        max_quantity <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    enabled_categories <span class="op">=</span> [category <span class="cf">for</span> category <span class="kw">in</span> available_gems[<span class="st">&#39;NORMAL&#39;</span>][<span class="st">&#39;CATEGORY&#39;</span>].keys(</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="cf">if</span> character.level <span class="op">&gt;=</span> available_gems[<span class="st">&#39;NORMAL&#39;</span>][<span class="st">&#39;CATEGORY&#39;</span>][category][<span class="st">&#39;drop&#39;</span>][<span class="st">&#39;min_level&#39;</span>]]</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(randrange(max_quantity) <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        selected_category <span class="op">=</span> choice(enabled_categories)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        gem_type <span class="op">=</span> available_gems[<span class="st">&#39;NORMAL&#39;</span>][<span class="st">&quot;CATEGORY&quot;</span>][selected_category]</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        drop_chance <span class="op">=</span> gem_type[<span class="st">&#39;drop&#39;</span>][<span class="st">&#39;chance&#39;</span>]</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>        max_chance <span class="op">=</span> gem_type[<span class="st">&#39;drop&#39;</span>][<span class="st">&#39;max_chance&#39;</span>]</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> modifier <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>            new_chance <span class="op">=</span> drop_chance <span class="op">+</span> modifier</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>            drop_chance <span class="op">=</span> new_chance <span class="cf">if</span> new_chance <span class="op">&lt;</span> max_chance <span class="cf">else</span> max_chance</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> random() <span class="op">&lt;=</span> drop_chance:</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>            looted_gems.append({</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;type&quot;</span>: choice(GAME_ITEMS[<span class="st">&#39;GEMS&#39;</span>][<span class="st">&quot;NORMAL&quot;</span>][<span class="st">&quot;TYPES&quot;</span>]),</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;category&quot;</span>: selected_category,</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;quantity&quot;</span>: <span class="dv">1</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> looted_gems</span></code></pre></div>
<p>Por lo que nuestra función <code>start_loot</code> tiene su versión
final que es:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> start_loot(character: Character, origin: <span class="bu">str</span>) <span class="op">-&gt;</span> List[Dict]:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    selected_pool: <span class="bu">dict</span> <span class="op">=</span> build_pool(character, origin)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    selected_items <span class="op">=</span> choose_items_with_weight_calculation(selected_pool)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    dropped_items <span class="op">=</span> apply_drop_chance(selected_items, <span class="fl">0.05</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    gold <span class="op">=</span> randrange(<span class="dv">10000</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    gems <span class="op">=</span> loot_gems(character)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;items&quot;</span>: dropped_items, <span class="st">&quot;gold&quot;</span>: gold, <span class="st">&quot;gems&quot;</span>: gems}</span></code></pre></div>
<h1
id="tuneando-el-script-para-recibir-argumentos-y-lanzar-n-simulaciones">Tuneando
el script para recibir argumentos y lanzar n simulaciones</h1>
<p>Ahora mismo tenemos una versión funcional pero necesitamos un display
de datos para tomar decisiones en nuestro juego y ver si por ejemplo en
1000 simulaciones abriendo distintos cofres cuantos legendarios
aparecen. Si vemos que salen mas que objetos normales el sistema de loot
es una puta mierda y hay que modificarlo para alcanzar ese equilibrio
imposible.</p>
<h2 id="argparse-al-rescate">Argparse al rescate</h2>
<p>Después de haber creado herramientas con bash donde necesitaba leer
argumentos del usuario, el modus operando de python es infinitamente mas
comodo y encima existen librerias que lo hacen mas profesional y
bonito.</p>
<p>Para simplificar la tarea he decidido usar <code>argparse</code> que
incluye la libreria estandar de python</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">&#39;&#39;&#39;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="st">Simulate multiple loots for a Diablo 3 character</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="st">EXAMPLES:</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="st">    python loot.py --level 61 -c monk</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="st">    python loot.py -l 50 --character_class &quot;witch doctor&quot;  # Wrap around quotes to allow whitespaces</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="st">    python loot.py --level 2 -c wizard --num-simulations 10000</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="st">    python loot.py --level 70 -c barbarian --num-simulations 500 --output &quot;dist/result.json&quot;</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&#39;&#39;</span>, formatter_class<span class="op">=</span>argparse.RawDescriptionHelpFormatter, epilog<span class="op">=</span><span class="st">&#39;Enjoy the loot!&#39;</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;-c&#39;</span>, <span class="st">&#39;--character_class&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, choices<span class="op">=</span>GAME_CLASSES,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">help</span><span class="op">=</span><span class="ss">f&quot;The character class you want to use in the loot process&quot;</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;-l&#39;</span>, <span class="st">&#39;--level&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, choices<span class="op">=</span><span class="bu">range</span>(</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>, <span class="dv">71</span>), <span class="bu">help</span><span class="op">=</span><span class="st">&#39;The started level for the character (between 1 and 70)&#39;</span>, metavar<span class="op">=</span><span class="st">&quot;61&quot;</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;-s&#39;</span>, <span class="st">&#39;--num-simulations&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">help</span><span class="op">=</span><span class="st">&#39;The numbers of simulations to be performed&#39;</span>, metavar<span class="op">=</span><span class="st">&quot;100&quot;</span>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;-o&#39;</span>, <span class="st">&#39;--output&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, default<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Select a filepath to output the results in .json format&quot;</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--enabled-origins&#39;</span>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;-v&#39;</span>, <span class="st">&#39;--version&#39;</span>, action<span class="op">=</span><span class="st">&#39;version&#39;</span>,</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>                        version<span class="op">=</span><span class="st">&#39;</span><span class="sc">%(prog)s</span><span class="st"> 1.0&#39;</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> (args.character_class <span class="kw">and</span> args.level) <span class="kw">or</span> args.num_simulations <span class="op">&lt;</span> <span class="dv">1</span>:</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>        parser.print_help()</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    character <span class="op">=</span> Character(args.level, args.character_class)</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    simulation_result <span class="op">=</span> simulate_loot(character, args.num_simulations)</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    show_simulation_result(character, simulation_result)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.output:</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(args.output, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> results_file:</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>            json.dump(simulation_result, results_file)</span></code></pre></div>
<h2 id="mostrando-resultados-en-pantalla-a-modo-resumen">Mostrando
resultados en pantalla a modo resumen</h2>
<p>En el bloque de código anterior existe una función llamada
<code>show_simulation_result</code> que no hemos implementado aun pero
lo único que hace es recibir el loot generado total y mostrar un resumen
en pantalla.</p>
<p>Antes establece los códigos de escape ANSI que representan colores de
forma global en el script:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ANSI ESCAPE CODE COLOURS</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>green <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\033</span><span class="st">[32m&#39;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>orange <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\033</span><span class="st">[38;5;208m&#39;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>blue <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\033</span><span class="st">[34m&#39;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>red <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\033</span><span class="st">[31m&#39;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>yellow <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\033</span><span class="st">[33m&#39;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>purple <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\033</span><span class="st">[1;35m&#39;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>cyan <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\033</span><span class="st">[1;36m&#39;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>gray <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\033</span><span class="st">[1;37m&#39;</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>reset <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\033</span><span class="st">[0m&#39;</span></span></code></pre></div>
<p>Y creamos la lógica de display para ver que está generando a vista de
pájaro nuestras simulaciones de loot:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_simulation_result(character: Character, result: Dict):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    gem_colors <span class="op">=</span> {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;AMETHYST&quot;</span>: purple,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;DIAMOND&quot;</span>: cyan,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;EMERALD&quot;</span>: green,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;RUBY&quot;</span>: red,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;TOPAZ&quot;</span>: yellow</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    equipment_rarity_colors <span class="op">=</span> {</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;legendary&quot;</span>: orange,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;character_set&quot;</span>: green,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;magic&quot;</span>: blue,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;rare&quot;</span>: yellow,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;normal&quot;</span>: gray</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> gem <span class="kw">in</span> <span class="bu">sorted</span>(result[<span class="st">&#39;gems&#39;</span>], key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">&#39;type&#39;</span>], reverse<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f&quot;A total of </span><span class="sc">{</span>gem[<span class="st">&#39;quantity&#39;</span>]<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>gem_colors[gem[<span class="st">&#39;type&#39;</span>]]<span class="sc">}{</span>gem[<span class="st">&#39;type&#39;</span>]<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>gem[<span class="st">&#39;category&#39;</span>]<span class="sc">}{</span>reset<span class="sc">}</span><span class="ss"> have come out&quot;</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">The global statistical data for the amount of gold generated in each simulation:&quot;</span>, end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f&quot;Total gold looted: </span><span class="sc">{</span>yellow<span class="sc">}{</span><span class="bu">format</span>(character.gold, <span class="st">&#39;,d&#39;</span>)<span class="sc">}{</span>reset<span class="sc">}</span><span class="ss">&quot;</span>, end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;...&quot;</span>, end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Mean: &quot;</span>, statistics.mean(result[<span class="st">&#39;gold&#39;</span>]), end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Median: &quot;</span>, statistics.median(result[<span class="st">&#39;gold&#39;</span>]), end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Mode: &quot;</span>, statistics.mode(result[<span class="st">&#39;gold&#39;</span>]), end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Variance: &quot;</span>, statistics.variance(result[<span class="st">&#39;gold&#39;</span>]), end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Standard deviation: &quot;</span>, statistics.stdev(result[<span class="st">&#39;gold&#39;</span>]), end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;...&quot;</span>, end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    equipment_keys <span class="op">=</span> GAME_ITEMS.keys()</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> result.keys():</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="ss">f&quot;</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">_equipment&quot;</span>.upper() <span class="kw">in</span> equipment_keys:</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f&quot;A total of </span><span class="sc">{</span><span class="bu">len</span>(result[key])<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>equipment_rarity_colors[key]<span class="sc">}{</span>key<span class="sc">}{</span>reset<span class="sc">}</span><span class="ss"> items has been looted&quot;</span>, end<span class="op">=</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<p>He ejecutado el comando con los siguientes argumentos
<code>python loot.py -l 65 -c "witch doctor" -s 1000</code> y he
obtenido el siguiente output:</p>
<figure>
<img src="/assets/images/loot.gif" alt="loot.py" />
<figcaption aria-hidden="true">loot.py</figcaption>
</figure>
<div class="sourceCode" id="cb29"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> INIT <span class="bu">]</span> <span class="ex">Starting</span> the loot process with a total of 1000 simulations</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> CHARACTER <span class="bu">]</span> <span class="ex">Selected</span> character class WITCH DOCTOR with level 65</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 13 AMETHYST <span class="at">-</span> STAR have come out</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 5 AMETHYST <span class="at">-</span> FLAWLESS IMPERIAL have come out</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 9 AMETHYST <span class="at">-</span> IMPERIAL have come out</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 23 AMETHYST <span class="at">-</span> SQUARE have come out</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 30 AMETHYST <span class="at">-</span> FLAWLESS have come out</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 14 AMETHYST <span class="at">-</span> FLAWLESS SQUARE have come out</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 9 AMETHYST <span class="at">-</span> MARQUISE have come out</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 17 DIAMOND <span class="at">-</span> FLAWLESS SQUARE have come out</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 18 DIAMOND <span class="at">-</span> IMPERIAL have come out</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 12 DIAMOND <span class="at">-</span> FLAWLESS IMPERIAL have come out</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 21 DIAMOND <span class="at">-</span> FLAWLESS have come out</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 18 DIAMOND <span class="at">-</span> SQUARE have come out</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 27 DIAMOND <span class="at">-</span> STAR have come out</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 9 DIAMOND <span class="at">-</span> MARQUISE have come out</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 18 EMERALD <span class="at">-</span> SQUARE have come out</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 21 EMERALD <span class="at">-</span> FLAWLESS SQUARE have come out</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 15 EMERALD <span class="at">-</span> IMPERIAL have come out</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 28 EMERALD <span class="at">-</span> FLAWLESS have come out</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 12 EMERALD <span class="at">-</span> MARQUISE have come out</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 14 EMERALD <span class="at">-</span> STAR have come out</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 7 EMERALD <span class="at">-</span> FLAWLESS IMPERIAL have come out</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 30 RUBY <span class="at">-</span> FLAWLESS have come out</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 9 RUBY <span class="at">-</span> IMPERIAL have come out</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 20 RUBY <span class="at">-</span> MARQUISE have come out</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 16 RUBY <span class="at">-</span> STAR have come out</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 6 RUBY <span class="at">-</span> FLAWLESS IMPERIAL have come out</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 19 RUBY <span class="at">-</span> FLAWLESS SQUARE have come out</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 19 RUBY <span class="at">-</span> SQUARE have come out</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 16 TOPAZ <span class="at">-</span> FLAWLESS SQUARE have come out</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 25 TOPAZ <span class="at">-</span> SQUARE have come out</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 25 TOPAZ <span class="at">-</span> FLAWLESS have come out</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 18 TOPAZ <span class="at">-</span> IMPERIAL have come out</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 15 TOPAZ <span class="at">-</span> STAR have come out</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 12 TOPAZ <span class="at">-</span> MARQUISE have come out</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 5 TOPAZ <span class="at">-</span> FLAWLESS IMPERIAL have come out</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="ex">The</span> global statistical data for the amount of gold generated in each simulation:</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="ex">Total</span> gold looted: 5,072,281</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a><span class="ex">Mean:</span>  5072.281</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a><span class="ex">Median:</span>  5160.5</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="ex">Mode:</span>  6301</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a><span class="ex">Variance:</span>  8303389.565604605</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a><span class="ex">Standard</span> deviation:  2881.5602658290186</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 471 rare items has been looted</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 688 normal items has been looted</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 930 magic items has been looted</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 38 legendary items has been looted</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a><span class="ex">A</span> total of 10 character_set items has been looted</span></code></pre></div>
<h1 id="palabras-finales">Palabras finales</h1>
<p>Bueno, en nuestro primer try tenemos un bajo drop rate de legendarios
y piezas de conjunto, ya que 1000 cofres de distintos tipos son muchos
cofres. Ahora es cuestión de calibrar la balanza simulando loots con el
sistema que hemos creado, es una versión muy rudimentaria y basuresca
por lo que te animo a mejorarla o crear la tuya propia.</p>
<p>Me ha parecido un proyecto bastante interesante porque toca mucho
manejo de diccionarios, loops y tratamiento de archivos con el extra de
aventurarme en el mundo del scrapping lo que me ha permitido sentirme
cómodo con python en una semana</p>
<h1 id="fuentes">Fuentes</h1>
<ul>
<li><a
href="https://learn.microsoft.com/en-us/minecraft/creator/documents/introductiontoloottables">Introduction
to loot tables</a></li>
<li><a href="https://realpython.com">Real python</a></li>
</ul></section>
    </main>
  </body>
</html>
